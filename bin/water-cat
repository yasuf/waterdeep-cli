#!/usr/bin/env node

const program = require('commander');
const http = require('http');

program
  .parse(process.argv);

const fileRoute = program.args[0];

if (!fileRoute) {
  console.error('"username/filename" required');
  process.exit(1);
}

if (fileRoute.indexOf('/') < 0) {
  console.error("\"username/filename\" must contain a '/' for example: water cat user12/file.js");
  process.exit(1);
}

const baseUrl = 'http://raw.waterdeep.io';

http.get(`${baseUrl}/${fileRoute}`, (response) => {
  const { statusCode } = response;
  const contentType = response.headers['content-type'];

  let error
  if (statusCode !== 200) {
    error = new Error(`Request failed\n Status Code: ${statusCode}`)
  }
  if (/^application\/json/.test(contentType)) {
    error = new Error(`Invalid content-type\n Expected application/json but received ${contentType}`)
  }
  if (error) {
    console.error(error.message);
    process.exit(1);
  }

  let rawData = ''

  response.on('data', (chunk) => {
    rawData += chunk;
  });

  response.on('end', () => {
    try {
      console.log(rawData);
    } catch(e) {
      console.error(e.message);
    }
  });
});


